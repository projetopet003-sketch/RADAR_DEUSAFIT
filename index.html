<!DOCTYPE html>
<html lang="es-MX">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RADAR DEUSAFIT v4.5 | Final Build</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- DESIGN SYSTEM ELITE v12.0 --- */
        :root {
            --gold: #D4AF37;
            --purple: #a855f7;
            --neon-blue: #00f3ff;
            --danger: #ef4444;
            --black-deep: #050505;
        }

        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: var(--black-deep); 
            color: #e0e0e0;
            overflow: hidden; 
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .font-tech { font-family: 'Rajdhani', sans-serif; }

        /* SCROLL APENAS NA LISTA */
        #scroll-content { 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 120px; 
        }
        #scroll-content::-webkit-scrollbar { width: 3px; }
        #scroll-content::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        /* ANIMA√á√ïES & STATES */
        .active-screen { display: flex !important; flex-direction: column; animation: fadeIn 0.8s forwards; }
        .hidden-screen { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* EFEITO DE SCANNER BIOM√âTRICO */
        .scan-gradient {
            background: linear-gradient(0deg, rgba(168,85,247,0.8) 0%, rgba(236,72,153,0.8) 50%, rgba(59,130,246,0.8) 100%);
            box-shadow: 0 0 30px rgba(168,85,247, 0.6);
        }

        /* ESTILOS DOS BOT√ïES CORTISOL */
        .btn-cortisol-active.FACE { background: rgba(59, 130, 246, 0.15); border-color: #60a5fa; color: #60a5fa; box-shadow: 0 0 20px rgba(59,130,246,0.3); }
        .btn-cortisol-active.BELLY { background: rgba(34, 197, 94, 0.15); border-color: #4ade80; color: #4ade80; box-shadow: 0 0 20px rgba(34,197,94,0.3); }
        .btn-cortisol-active.SLEEP { background: rgba(168, 85, 247, 0.15); border-color: #c084fc; color: #c084fc; box-shadow: 0 0 20px rgba(168,85,247,0.3); }

        .goal-btn.active { background: rgba(212, 175, 55, 0.2); border-color: var(--gold); color: var(--gold); font-weight: bold; box-shadow: 0 0 15px rgba(212,175,55,0.2); }
        
        /* GLASS CARD & WARNING */
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .warning-card {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.1);
        }

        /* NEW: VISUALIZER ONDAS BINAURAIS */
        .visualizer-container { display: flex; align-items: center; justify-content: center; gap: 4px; height: 40px; margin: 10px 0; }
        .v-bar { width: 4px; background: #a855f7; border-radius: 4px; height: 10%; transition: 0.2s; }
        .playing .v-bar { animation: sound 0.5s infinite alternate; }
        @keyframes sound { 0% { height: 20%; } 100% { height: 100%; box-shadow: 0 0 10px #a855f7; } }
        .v-bar:nth-child(1) { animation-delay: 0.1s; } .v-bar:nth-child(2) { animation-delay: 0.3s; }
        .v-bar:nth-child(3) { animation-delay: 0.5s; } .v-bar:nth-child(4) { animation-delay: 0.2s; }
        .v-bar:nth-child(5) { animation-delay: 0.4s; }

        /* Checkbox Custom */
        .nexus-check input:checked + div { background-color: var(--gold); border-color: var(--gold); }
        .nexus-check input:checked + div i { opacity: 1; }
    </style>
</head>
<body class="antialiased h-screen w-screen bg-black flex flex-col">

    <div id="screen-intro" class="fixed inset-0 z-[10000] bg-[#020202] flex flex-col justify-center items-center p-6 active-screen">
        <div class="absolute inset-0 opacity-40 bg-[url('boneca_cortisol.png')] bg-contain bg-center bg-no-repeat pointer-events-none"></div>
        
        <div class="relative z-10 flex flex-col items-center text-center mt-32">
            <h1 class="font-tech text-4xl text-white tracking-[0.2em] mb-2 drop-shadow-[0_0_10px_rgba(168,85,247,0.5)]">RADAR <span class="text-purple-500">DEUSAFIT</span></h1>
            <p class="text-[10px] text-gray-400 tracking-[0.5em] mb-16 uppercase font-bold">Sistema de Bio-Hacking Latam</p>
            
            <div class="relative w-28 h-28 mb-8">
                <div class="absolute inset-0 border border-purple-500/30 rounded-full animate-ping"></div>
                <div class="absolute inset-0 border border-purple-500/10 rounded-full animate-pulse delay-75"></div>
                
                <button id="fingerprint-btn" 
                        onmousedown="startScan(event)" ontouchstart="startScan(event)" 
                        onmouseup="endScan()" ontouchend="endScan()" 
                        onmouseleave="endScan()"
                        class="w-full h-full rounded-full bg-black/40 border border-purple-500/40 flex items-center justify-center relative overflow-hidden transition-transform duration-100 active:scale-95 backdrop-blur-sm z-20">
                    <i data-lucide="fingerprint" class="w-14 h-14 text-gray-500 relative z-30 transition-colors duration-300" id="scan-icon"></i>
                    <div id="scan-fill" class="absolute bottom-0 left-0 w-full scan-gradient opacity-90 transition-all duration-[200ms] z-10" style="height: 0%"></div>
                </button>
            </div>
            <p id="intro-text" class="text-[10px] text-gray-500 font-tech tracking-widest animate-pulse">MANTENGA PRESIONADO PARA ESCANEAR</p>
        </div>
    </div>

    <div id="screen-quiz" class="hidden-screen fixed inset-0 z-[9000] bg-black flex flex-col px-8 justify-center pb-20">
        <div class="mb-10 relative z-10">
            <span class="text-[9px] text-purple-400 font-tech uppercase tracking-widest border border-purple-500/30 px-3 py-1 rounded bg-purple-900/10">Fase 1: Calibraci√≥n</span>
            <h2 class="text-3xl text-white mt-6 font-light leading-tight">Identificando tu <br><span class="text-purple-400 font-bold font-tech text-4xl">PERFIL INFLAMATORIO</span></h2>
        </div>
        
        <div id="q1" class="quiz-step relative z-10 animate-fade-in">
            <p class="text-base text-gray-300 mb-8 font-light">1. Al despertar, ¬øsientes tu rostro hinchado <span class="text-white font-bold">(Cara de Luna)</span>?</p>
            <div class="space-y-4">
                <button onclick="answerQuiz('FACE', 1)" class="w-full p-5 rounded-xl bg-white/5 border border-white/10 text-left hover:border-purple-500 active:bg-purple-900/20 transition-all flex justify-between group"><span class="text-sm font-tech text-gray-200">S√ç, MUY HINCHADA</span><i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i></button>
                <button onclick="answerQuiz('NORMAL', 1)" class="w-full p-5 rounded-xl bg-white/5 border border-white/10 text-left hover:border-purple-500 active:bg-purple-900/20 transition-all flex justify-between group"><span class="text-sm font-tech text-gray-200">NO, ES NORMAL</span><i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i></button>
            </div>
        </div>
        <div id="q2" class="quiz-step hidden relative z-10 animate-fade-in">
            <p class="text-base text-gray-300 mb-8 font-light">2. ¬øSientes el abdomen abultado o digesti√≥n pesada?</p>
            <div class="space-y-4">
                <button onclick="answerQuiz('BELLY', 2)" class="w-full p-5 rounded-xl bg-white/5 border border-white/10 text-left hover:border-gold active:bg-yellow-900/20 transition-all flex justify-between group"><span class="text-sm font-tech text-gray-200">S√ç, SIEMPRE</span><i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i></button>
                <button onclick="answerQuiz('NORMAL', 2)" class="w-full p-5 rounded-xl bg-white/5 border border-white/10 text-left hover:border-gold active:bg-yellow-900/20 transition-all flex justify-between group"><span class="text-sm font-tech text-gray-200">A VECES / RARA VEZ</span><i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i></button>
            </div>
        </div>
        <div id="q3" class="quiz-step hidden relative z-10 animate-fade-in">
            <p class="text-base text-gray-300 mb-8 font-light">3. ¬øTe cuesta dormir o despiertas con ansiedad?</p>
            <div class="space-y-4">
                <button onclick="answerQuiz('SLEEP', 3)" class="w-full p-5 rounded-xl bg-white/5 border border-white/10 text-left hover:border-purple-500 active:bg-purple-900/20 transition-all flex justify-between group"><span class="text-sm font-tech text-gray-200">DUERMO MAL / INSOMNIO</span><i data-lucide="check" class="w-5 h-5 text-gray-600"></i></button>
                <button onclick="answerQuiz('NORMAL', 3)" class="w-full p-5 rounded-xl bg-white/5 border border-white/10 text-left hover:border-purple-500 active:bg-purple-900/20 transition-all flex justify-between group"><span class="text-sm font-tech text-gray-200">DUERMO BIEN</span><i data-lucide="check" class="w-5 h-5 text-gray-600"></i></button>
            </div>
        </div>
        <div id="q4" class="quiz-step hidden relative z-10 animate-fade-in">
            <p class="text-base text-gray-300 mb-8 font-light">4. ¬øQu√© tipo de antojo tienes con m√°s frecuencia?</p>
            <div class="space-y-4">
                <button onclick="answerQuiz('BELLY', 4)" class="w-full p-5 rounded-xl bg-white/5 border border-white/10 text-left hover:border-purple-500 active:bg-purple-900/20 transition-all flex justify-between group"><span class="text-sm font-tech text-gray-200">DULCES / HARINAS</span><i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i></button>
                <button onclick="answerQuiz('FACE', 4)" class="w-full p-5 rounded-xl bg-white/5 border border-white/10 text-left hover:border-purple-500 active:bg-purple-900/20 transition-all flex justify-between group"><span class="text-sm font-tech text-gray-200">SALADO / CRUJIENTE</span><i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i></button>
            </div>
        </div>
        <div id="q5" class="quiz-step hidden relative z-10 animate-fade-in">
            <p class="text-base text-gray-300 mb-8 font-light">5. ¬øC√≥mo es tu nivel de energ√≠a?</p>
            <div class="space-y-4">
                <button onclick="answerQuiz('NORMAL', 5)" class="w-full p-5 rounded-xl bg-white/5 border border-white/10 text-left hover:border-purple-500 active:bg-purple-900/20 transition-all flex justify-between group"><span class="text-sm font-tech text-gray-200">CANSANCIO CONSTANTE</span><i data-lucide="check" class="w-5 h-5 text-gray-600"></i></button>
                <button onclick="answerQuiz('SLEEP', 5)" class="w-full p-5 rounded-xl bg-white/5 border border-white/10 text-left hover:border-purple-500 active:bg-purple-900/20 transition-all flex justify-between group"><span class="text-sm font-tech text-gray-200">ME ACTIVO DE NOCHE</span><i data-lucide="check" class="w-5 h-5 text-gray-600"></i></button>
            </div>
        </div>

        <div id="processing" class="hidden text-center mt-20 animate-fade-in">
            <div class="w-16 h-16 border-2 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-6 shadow-[0_0_20px_rgba(168,85,247,0.4)]"></div>
            <p class="font-tech text-sm tracking-[0.2em] text-purple-400 animate-pulse">ANALIZANDO BIOMETR√çA...</p>
        </div>
    </div>

    <div id="app-shell" class="hidden-screen h-full w-full bg-[#050505] flex flex-col relative">
        
        <header class="z-50 bg-[#080808]/95 backdrop-blur-sm border-b border-white/5 shrink-0">
            <div class="flex justify-between items-center px-5 py-4"> 
                <button onclick="openVipLink()" class="flex items-center gap-3 group active:scale-95 transition-transform cursor-pointer">
                    <div class="w-9 h-9 rounded-full bg-gradient-to-tr from-yellow-700 to-yellow-500 flex items-center justify-center shadow-[0_0_15px_rgba(212,175,55,0.2)] border border-yellow-400/30">
                        <i data-lucide="crown" class="w-4 h-4 text-black fill-black"></i>
                    </div>
                    <div class="text-left">
                        <div class="text-[9px] text-gray-400 font-tech tracking-widest">COMUNIDAD</div>
                        <div class="text-xs text-white font-bold tracking-wide">VIP CLUB</div>
                    </div>
                </button>
                <button onclick="toggleConfig()" class="w-9 h-9 rounded-full border border-white/10 flex items-center justify-center hover:bg-white/5 transition-colors">
                    <i data-lucide="settings-2" class="w-5 h-5 text-gray-400"></i>
                </button>
            </div>

            <div class="px-5 pb-4">
                <div class="flex justify-between items-end mb-2">
                    <span id="protocol-status" class="text-[10px] text-green-400 font-tech tracking-widest uppercase flex items-center gap-1"><i data-lucide="shield-check" class="w-3 h-3"></i> SISTEMA NORMAL</span>
                    <div class="text-right">
                        <span id="current-kcal" class="text-2xl font-bold text-white font-tech">0</span>
                        <span class="text-[10px] font-tech text-gray-500">/ <span id="target-kcal" class="text-gold font-bold">2000</span></span>
                    </div>
                </div>
                <div class="h-2 bg-gray-800 rounded-full overflow-hidden relative mb-3 shadow-inner">
                    <div id="main-bar" class="h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-700 ease-out" style="width: 0%"></div>
                </div>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="bg-blue-900/10 border border-blue-900/30 rounded py-2"><span class="block text-[8px] text-blue-400 font-bold tracking-wider mb-1">PROT</span><span id="val-prot" class="text-xs font-tech text-white">0/100g</span></div>
                    <div class="bg-yellow-900/10 border border-yellow-900/30 rounded py-2"><span class="block text-[8px] text-yellow-400 font-bold tracking-wider mb-1">CARB</span><span id="val-carb" class="text-xs font-tech text-white">0/100g</span></div>
                    <div class="bg-orange-900/10 border border-orange-900/30 rounded py-2"><span class="block text-[8px] text-orange-400 font-bold tracking-wider mb-1">GRASA</span><span id="val-fat" class="text-xs font-tech text-white">0/50g</span></div>
                </div>
            </div>
        </header>

        <div class="bg-[#050505] border-b border-white/5 shrink-0 p-5 z-40 shadow-xl relative">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xs text-gray-400 font-tech uppercase tracking-[0.2em] flex items-center gap-2"><i data-lucide="activity" class="w-3 h-3 text-purple-500"></i> ESC√ÅNER DE CORTISOL</h3>
                <button onclick="resetCortisol()" class="text-[9px] text-gray-500 hover:text-white underline decoration-gray-700">RESET</button>
            </div>
            <div class="grid grid-cols-3 gap-3 mb-0">
                <button onclick="activateCortisol('FACE')" id="btn-FACE" class="bg-gray-900/40 border border-gray-800 rounded-xl p-3 text-gray-400 transition-all flex flex-col items-center gap-2 group hover:bg-gray-800">
                    <i data-lucide="droplet" class="w-6 h-6 text-blue-400/50 group-hover:text-blue-400 transition-colors"></i> 
                    <span class="font-tech text-[10px] tracking-wider">CARA</span>
                </button>
                <button onclick="activateCortisol('BELLY')" id="btn-BELLY" class="bg-gray-900/40 border border-gray-800 rounded-xl p-3 text-gray-400 transition-all flex flex-col items-center gap-2 group hover:bg-gray-800">
                    <i data-lucide="shield" class="w-6 h-6 text-green-400/50 group-hover:text-green-400 transition-colors"></i> 
                    <span class="font-tech text-[10px] tracking-wider">ABDOMEN</span>
                </button>
                <button onclick="activateCortisol('SLEEP')" id="btn-SLEEP" class="bg-gray-900/40 border border-gray-800 rounded-xl p-3 text-gray-400 transition-all flex flex-col items-center gap-2 group hover:bg-gray-800">
                    <i data-lucide="moon" class="w-6 h-6 text-purple-400/50 group-hover:text-purple-400 transition-colors"></i> 
                    <span class="font-tech text-[10px] tracking-wider">SUE√ëO</span>
                </button>
            </div>
            
            <div id="cortisol-card" class="hidden mt-4 animate-fade-in border-t border-white/5 pt-4">
            </div>
        </div>

        <main id="scroll-content" class="flex-1 bg-[#050505] p-5">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-white/5 sticky top-0 bg-[#050505] z-10 pt-2 backdrop-blur-sm">
                <h3 class="text-[10px] text-gray-500 font-tech uppercase tracking-[0.2em] flex items-center gap-2">
                    <i data-lucide="database" class="w-3 h-3 text-gray-500"></i> BASE DE DATOS (52)
                </h3>
                <button onclick="resetFood()" class="flex items-center gap-1 text-[9px] text-red-400 hover:text-red-300 border border-red-900/30 px-3 py-1.5 rounded bg-red-900/10 transition-colors">
                    <i data-lucide="trash-2" class="w-3 h-3"></i> LIMPIAR
                </button>
            </div>
            <div class="mb-6 mt-2"> <button onclick="window.location.href='scanner.html'" class="w-full group relative overflow-hidden rounded-xl p-[1px] transition-all hover:scale-[1.01] active:scale-95 shadow-lg shadow-purple-900/20">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-900 via-purple-500 to-purple-900 opacity-40 group-hover:opacity-100 transition-opacity duration-500"></div>
                    
                    <div class="relative bg-[#080808] rounded-xl p-3 flex items-center justify-between border border-white/5">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-purple-500/10 border border-purple-500/20 flex items-center justify-center relative overflow-hidden">
                                <div class="absolute inset-0 bg-purple-500/20 animate-pulse"></div>
                                <i data-lucide="scan-face" class="w-5 h-5 text-purple-400 relative z-10"></i>
                            </div>
                            
                            <div class="text-left">
                                <h4 class="font-tech text-white text-sm tracking-[0.2em] font-bold">BIO-SCANNER <span class="text-[8px] text-purple-400 border border-purple-500/30 px-1 rounded ml-1">VFC</span></h4>
                                <p class="text-[9px] text-gray-500 font-light leading-none mt-1">Descubra la causa oculta de la inflamaci√≥n.</p>
                            </div>
                        </div>
                        
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 group-hover:text-purple-400 transition-colors"></i>
                    </div>
                </button>
            </div>
            <div id="food-container" class="space-y-3">
            <div id="food-container" class="space-y-3">
            </div>

            <div class="mt-8 warning-card rounded-xl p-4 flex gap-4 animate-pulse">
                <div class="shrink-0 pt-1">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-500"></i>
                </div>
                <div>
                    <h4 class="text-red-400 font-bold font-tech text-sm tracking-wider uppercase mb-1">ADVERTENCIA FUNCIONAL</h4>
                    <p class="text-[10px] text-gray-400 leading-relaxed">
                        Los alimentos marcados como <span class="text-red-500 font-bold">INFLAMATORIOS</span> elevan el cortisol y bloquean la quema de grasa. 
                        <br>Su presencia en esta lista es solo para <strong>registro de fallas</strong>, no recomendaci√≥n.
                    </p>
                </div>
            </div>
        </main>

        <footer class="shrink-0 bg-[#080808] border-t border-white/10 pb-6 pt-2 z-50">
            <div class="max-w-md mx-auto grid grid-cols-3 gap-2 px-6">
                <button onclick="handleDetoxClick()" class="group flex flex-col items-center justify-center p-2 rounded hover:bg-white/5 transition-colors relative">
                    <i data-lucide="flask-conical" class="w-6 h-6 text-gray-500 group-hover:text-green-400 transition-colors"></i>
                    <span class="text-[9px] font-tech text-gray-500 tracking-wider mt-1 group-hover:text-green-400">DETOX</span>
                    <div id="lock-detox" class="absolute top-1 right-4 bg-black rounded-full border border-black"><i data-lucide="lock" class="w-3 h-3 text-gray-600"></i></div>
                </button>
                <button onclick="openUpsell('DEUSA')" class="group flex flex-col items-center justify-center p-2 -mt-8">
                    <div class="w-16 h-16 bg-gradient-to-br from-gray-800 to-black border border-gray-700 rounded-full flex items-center justify-center shadow-lg group-hover:border-gold group-hover:shadow-[0_0_20px_rgba(212,175,55,0.3)] transition-all">
                        <i data-lucide="crown" class="w-7 h-7 text-gray-400 group-hover:text-gold transition-colors"></i>
                    </div>
                    <span class="text-[9px] font-tech text-gray-500 tracking-wider mt-2 group-hover:text-gold font-bold">RETO 21</span>
                </button>
                <button onclick="openUpsell('IGNICION')" class="group flex flex-col items-center justify-center p-2 rounded hover:bg-white/5 transition-colors">
                    <i data-lucide="zap" class="w-6 h-6 text-gray-500 group-hover:text-purple-400 transition-colors"></i>
                    <span class="text-[9px] font-tech text-gray-500 tracking-wider mt-1 group-hover:text-purple-400">IGNICI√ìN</span>
                </button>
            </div>
        </footer>
    </div>

    <div id="modal-expediente" class="fixed inset-0 z-[200] bg-black/95 hidden flex flex-col animate-fade-in backdrop-blur-xl">
        <div class="p-5 flex justify-between items-center border-b border-white/10 shrink-0">
            <h3 class="text-white font-tech text-lg tracking-widest flex items-center gap-2">
                <i data-lucide="file-text" class="w-5 h-5"></i> MI EXPEDIENTE
            </h3>
            <button onclick="closeExpediente()" class="text-gray-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div id="expediente-content" class="flex-1 overflow-y-auto p-6 space-y-6">
            </div>
    </div>
    
    <div id="modal-upsell" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-6 animate-fade-in">
        <div id="upsell-card" class="glass-card w-full max-w-sm p-8 rounded-xl border relative overflow-hidden shadow-2xl transition-all">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white z-20"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div class="flex justify-center mb-8 relative">
                <div id="modal-glow" class="absolute inset-0 blur-2xl rounded-full opacity-50"></div>
                <i id="modal-icon" data-lucide="lock" class="w-20 h-20 relative z-10 stroke-1"></i>
            </div>
            
            <div class="text-center relative z-10">
                <h3 id="modal-title" class="font-tech text-3xl mb-4 uppercase tracking-[0.2em] font-light leading-none">TITULO</h3>
                <p id="modal-desc" class="text-gray-400 text-xs mb-10 leading-relaxed px-4 tracking-wide font-light">Este protocolo de √©lite est√° bloqueado. ¬øDeseas desbloquear el acceso ahora?</p>
                <a href="#" id="modal-btn" class="block w-full font-bold font-tech py-4 text-center tracking-[0.2em] rounded-lg shadow-lg transition-all hover:scale-[1.02] active:scale-95 text-sm">DESBLOQUEAR AHORA</a>
            </div>
        </div>
    </div>

    <div id="modal-gallery" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl hidden flex flex-col">
        <div class="p-5 flex justify-between items-center border-b border-white/10">
            <h3 class="text-green-400 font-tech text-lg tracking-widest flex items-center gap-2"><i data-lucide="flask-conical" class="w-5 h-5"></i> RECETAS DETOX</h3>
            <button onclick="document.getElementById('modal-gallery').classList.add('hidden')" class="text-gray-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 flex flex-col justify-center">
            <div class="flex overflow-x-auto gap-4 snap-x pb-4">
                <img src="card_cha_01.png" class="min-w-[85%] rounded-xl shadow-lg snap-center border border-white/10">
                <img src="card_cha_02.png" class="min-w-[85%] rounded-xl shadow-lg snap-center border border-white/10">
                <img src="card_cha_03.png" class="min-w-[85%] rounded-xl shadow-lg snap-center border border-white/10">
            </div>
        </div>
    </div>
    
    <div id="config-panel" class="fixed inset-0 bg-[#050505]/95 backdrop-blur-xl z-[60] p-8 hidden flex flex-col justify-center">
        <div class="flex justify-between items-center mb-10 border-b border-white/10 pb-4"><h3 class="text-white font-tech text-2xl tracking-[0.2em]">MI PERFIL</h3><button onclick="toggleConfig()" class="text-gray-500 hover:text-white"><i data-lucide="x" class="w-8 h-8"></i></button></div>
        <div class="grid grid-cols-3 gap-5 mb-8">
            <div><label class="text-[9px] text-gray-500 block mb-2 tracking-wider">PESO (KG)</label><input type="number" id="in-weight" class="w-full bg-white/5 border border-white/10 rounded-lg p-4 text-white text-center font-mono text-xl focus:border-gold outline-none transition-colors" placeholder="60"></div>
            <div><label class="text-[9px] text-gray-500 block mb-2 tracking-wider">ALTURA</label><input type="number" id="in-height" class="w-full bg-white/5 border border-white/10 rounded-lg p-4 text-white text-center font-mono text-xl focus:border-gold outline-none transition-colors" placeholder="165"></div>
            <div><label class="text-[9px] text-gray-500 block mb-2 tracking-wider">EDAD</label><input type="number" id="in-age" class="w-full bg-white/5 border border-white/10 rounded-lg p-4 text-white text-center font-mono text-xl focus:border-gold outline-none transition-colors" placeholder="30"></div>
        </div>
        <div class="mb-8"><label class="text-[9px] text-gray-500 block mb-3 tracking-wider">OBJETIVO T√ÅTICO</label><div class="grid grid-cols-3 gap-3"><button onclick="setGoal('cut')" id="goal-cut" class="goal-btn bg-white/5 border border-white/10 p-4 rounded-lg text-[10px] font-bold text-center hover:border-blue-400 transition-colors uppercase text-gray-400 tracking-wide">üî• QUEMAR</button><button onclick="setGoal('maintain')" id="goal-maintain" class="goal-btn bg-white/5 border border-white/10 p-4 rounded-lg text-[10px] font-bold text-center hover:border-green-400 transition-colors uppercase text-gray-400 tracking-wide">‚öñÔ∏è MANTENER</button><button onclick="setGoal('bulk')" id="goal-bulk" class="goal-btn bg-white/5 border border-white/10 p-4 rounded-lg text-[10px] font-bold text-center hover:border-purple-400 transition-colors uppercase text-gray-400 tracking-wide">üçë GANAR</button></div></div>
        <button onclick="saveConfig()" class="w-full bg-gradient-to-r from-gold to-yellow-600 text-black font-bold font-tech py-4 rounded-lg shadow-gold hover:shadow-lg hover:scale-[1.02] transition-all text-sm tracking-[0.2em] flex items-center justify-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> GUARDAR DATOS</button>
    </div>

    <audio id="audio-player" src="sleep_audio.mp3" loop></audio>

    <script>
        // --- 1. DADOS DE CONTE√öDO (NOVOS LINKS E PROTOCOLOS) ---
        const CONFIG_LINKS = { 
            vip: "https://chat.whatsapp.com/JWOfIGxUiPCE293Jyaa4Th?mode=gi_t", 
            detox: "https://pay.hotmart.com/Q104296848Q", 
            deusa: "https://pay.hotmart.com/G103777959K?checkoutMode=10", 
            ignicion: "https://pay.hotmart.com/N103638586X" 
        };

        const PROTOCOLS = {
            FACE: {
                title: "ROSTRO DE LUNA", sub: "Drenaje Linf√°tico Facial", color: "blue", videoId: "5fthkvcofy",
                desc: "1. Lava tu rostro con agua fr√≠a.<br>2. Aplica aceite facial.<br>3. Con los nudillos, masajea desde la barbilla hasta las orejas (10x).<br>4. Masajea desde la nariz hacia afuera.",
                steps: [ {id:'f1', l:'Drenaje Manual 3min'}, {id:'f2', l:'Elixir Adrenal (Agua+Sal)'}, {id:'f3', l:'Choque T√©rmico (Hielo)'} ]
            },
            BELLY: {
                title: "GORDURA VISCERAL", sub: "Vacuum & Anti-LPL", color: "green", videoId: "p5vmstgamc",
                desc: "1. En ayunas, exhala todo el aire de tus pulmones.<br>2. Sin inhalar, mete el ombligo hacia adentro y arriba.<br>3. Aguanta 10-15 segundos.<br>4. Inhala suavemente y repite 3 veces.",
                steps: [ {id:'b1', l:'Vacuum Abdominal (3x)'}, {id:'b2', l:'T√© Amargo (Boldo)'}, {id:'b3', l:'Cero Gluten Hoy'} ]
            },
            SLEEP: {
                title: "CICLO CIRCADIANO", sub: "Reset Eje HPA", color: "purple", audioOnly: true,
                desc: "1. Apaga luces blancas 1h antes de dormir.<br>2. Ponte aud√≠fonos.<br>3. Dale play al audio y respira profundo (4s inhalar, 7s retener, 8s exhalar).",
                steps: [ {id:'s1', l:'Sol Matutino (10min)'}, {id:'s2', l:'Magnesio (500mg)'}, {id:'s3', l:'Audio Delta (30min)'} ]
            }
        };

        const db = [
            // LISTA ORIGINAL DE 52 ALIMENTOS (MANTIDA)
            { id: 'p1', name: 'Pechuga de Pollo', unit: '1 Filete', icon: 'üçó', type: 'prot', kcal: 120, p: 23, c: 0, f: 2.5 },
            { id: 'p2', name: 'Carne Molida Magra', unit: '100g', icon: 'ü•©', type: 'prot', kcal: 180, p: 20, c: 0, f: 10 },
            { id: 'p3', name: 'Lomo de Cerdo', unit: '1 Filete', icon: 'ü•ì', type: 'prot', kcal: 145, p: 21, c: 0, f: 6 },
            { id: 'p4', name: 'Huevo Entero', unit: '1 Unidad', icon: 'ü•ö', type: 'prot', kcal: 72, p: 6, c: 0.5, f: 5 },
            { id: 'p5', name: 'Claras de Huevo', unit: '3 Unidades', icon: 'üç≥', type: 'prot', kcal: 51, p: 11, c: 0, f: 0 },
            { id: 'p6', name: 'Tilapia/Pescado', unit: '1 Filete', icon: 'üêü', type: 'prot', kcal: 96, p: 20, c: 0, f: 1.7 },
            { id: 'p7', name: 'Salm√≥n', unit: '100g', icon: 'üç£', type: 'prot', kcal: 208, p: 20, c: 0, f: 13 },
            { id: 'p8', name: 'At√∫n en Agua', unit: '1 Lata', icon: 'ü•´', type: 'prot', kcal: 100, p: 22, c: 0, f: 1 },
            { id: 'p9', name: 'Camarones', unit: '100g', icon: 'ü¶ê', type: 'prot', kcal: 99, p: 24, c: 0, f: 0.3 },
            { id: 'p10', name: 'Yogur Griego', unit: '1 Taza', icon: 'ü•£', type: 'prot', kcal: 100, p: 10, c: 4, f: 0 },
            { id: 'p11', name: 'Queso Cottage', unit: '1/2 Taza', icon: 'üßÄ', type: 'prot', kcal: 81, p: 14, c: 3, f: 1 },
            { id: 'p12', name: 'Whey Protein', unit: '1 Scoop', icon: 'ü•§', type: 'prot', kcal: 110, p: 24, c: 2, f: 1 },
            { id: 'p13', name: 'Tofu', unit: '100g', icon: 'üßä', type: 'prot', kcal: 76, p: 8, c: 2, f: 4 },
            { id: 'p14', name: 'Pavo (Turkey)', unit: '100g', icon: 'ü¶É', type: 'prot', kcal: 104, p: 29, c: 0, f: 2 },
            { id: 'p15', name: 'Sardinas', unit: '1 Lata', icon: 'üêü', type: 'prot', kcal: 190, p: 23, c: 0, f: 10 },
            { id: 'c1', name: 'Arroz Blanco', unit: '1 Taza', icon: 'üçö', type: 'carb', kcal: 130, p: 2, c: 28, f: 0 },
            { id: 'c2', name: 'Arroz Integral', unit: '1 Taza', icon: 'üåæ', type: 'carb', kcal: 110, p: 3, c: 23, f: 1 },
            { id: 'c3', name: 'Avena', unit: '1/2 Taza', icon: 'ü•£', type: 'carb', kcal: 150, p: 5, c: 27, f: 3 },
            { id: 'c4', name: 'Quinoa', unit: '1 Taza', icon: 'ü•ó', type: 'carb', kcal: 120, p: 4, c: 21, f: 2 },
            { id: 'c5', name: 'Papa Cocida', unit: '1 Mediana', icon: 'ü•î', type: 'carb', kcal: 110, p: 3, c: 26, f: 0 },
            { id: 'c6', name: 'Camote/Batata', unit: '1 Mediana', icon: 'üç†', type: 'carb', kcal: 103, p: 2, c: 24, f: 0 },
            { id: 'c7', name: 'Pl√°tano', unit: '1 Unidad', icon: 'üçå', type: 'carb', kcal: 105, p: 1, c: 27, f: 0 },
            { id: 'c8', name: 'Frijoles Negros', unit: '1/2 Taza', icon: 'ü´ò', type: 'carb', kcal: 114, p: 8, c: 20, f: 0.5 },
            { id: 'c9', name: 'Lentejas', unit: '1/2 Taza', icon: 'ü•ò', type: 'carb', kcal: 115, p: 9, c: 20, f: 0.4 },
            { id: 'c10', name: 'Garbanzos', unit: '1/2 Taza', icon: 'üßÜ', type: 'carb', kcal: 134, p: 7, c: 22, f: 2 },
            { id: 'c11', name: 'Tortilla Ma√≠z', unit: '1 Unidad', icon: 'üåÆ', type: 'carb', kcal: 52, p: 1, c: 11, f: 0.7 },
            { id: 'c12', name: 'Pan Integral', unit: '1 Rebanada', icon: 'üçû', type: 'carb', kcal: 80, p: 4, c: 14, f: 1 },
            { id: 'c13', name: 'Pasta', unit: '1 Taza', icon: 'üçù', type: 'carb', kcal: 150, p: 5, c: 30, f: 1 },
            { id: 'c14', name: 'Arepa (Ma√≠z)', unit: '1 Med.', icon: 'ü´ì', type: 'carb', kcal: 180, p: 4, c: 35, f: 2 },
            { id: 'c15', name: 'Manzana', unit: '1 Unidad', icon: 'üçé', type: 'carb', kcal: 95, p: 0, c: 25, f: 0 },
            { id: 'c16', name: 'Yuca (Mandioca)', unit: '100g', icon: 'ü™µ', type: 'carb', kcal: 160, p: 1, c: 38, f: 0 },
            { id: 'c17', name: 'Pi√±a', unit: '1 Taza', icon: 'üçç', type: 'carb', kcal: 82, p: 1, c: 21, f: 0 },
            { id: 'f1', name: 'Aguacate/Palta', unit: '1/4 Unidad', icon: 'ü•ë', type: 'fat', kcal: 80, p: 1, c: 4, f: 7 },
            { id: 'f2', name: 'Aceite de Oliva', unit: '1 Cuch.', icon: 'ü´í', type: 'fat', kcal: 119, p: 0, c: 0, f: 13.5 },
            { id: 'f3', name: 'Aceite de Coco', unit: '1 Cuch.', icon: 'ü••', type: 'fat', kcal: 117, p: 0, c: 0, f: 14 },
            { id: 'f4', name: 'Mantequilla Man√≠', unit: '1 Cuch.', icon: 'ü•ú', type: 'fat', kcal: 94, p: 4, c: 3, f: 8 },
            { id: 'f5', name: 'Almendras', unit: '10 Un.', icon: 'üå∞', type: 'fat', kcal: 70, p: 3, c: 2, f: 6 },
            { id: 'f6', name: 'Nueces', unit: '5 Un.', icon: 'ü•ú', type: 'fat', kcal: 90, p: 2, c: 2, f: 9 },
            { id: 'f7', name: 'Choco 70% Dark', unit: '1 Cuad.', icon: 'üç´', type: 'fat', kcal: 50, p: 1, c: 4, f: 4 },
            { id: 'f8', name: 'Semillas Chia', unit: '1 Cuch.', icon: 'üå±', type: 'fat', kcal: 69, p: 2, c: 6, f: 4 },
            { id: 'v1', name: 'Br√≥coli', unit: '1 Taza', icon: 'ü•¶', type: 'veg', kcal: 30, p: 2, c: 6, f: 0 },
            { id: 'v2', name: 'Espinaca', unit: '1 Taza', icon: 'üçÉ', type: 'veg', kcal: 7, p: 1, c: 1, f: 0 },
            { id: 'v3', name: 'Zanahoria', unit: '1 Mediana', icon: 'ü•ï', type: 'veg', kcal: 25, p: 1, c: 6, f: 0 },
            { id: 'v4', name: 'Ensalada Mix', unit: 'Libre', icon: 'ü•ó', type: 'veg', kcal: 15, p: 1, c: 3, f: 0 },
            { id: 'v5', name: 'Calabac√≠n', unit: '1 Taza', icon: 'ü•í', type: 'veg', kcal: 20, p: 1, c: 4, f: 0 },
            { id: 'v6', name: 'Tomate', unit: '1 Unidad', icon: 'üçÖ', type: 'veg', kcal: 22, p: 1, c: 5, f: 0 },
            { id: 'v7', name: 'Esp√°rragos', unit: '5 Un.', icon: 'üéç', type: 'veg', kcal: 20, p: 2, c: 4, f: 0 },
            { id: 'x1', name: 'Pizza', unit: '1 Rebanada', icon: 'üçï', type: 'cheat', kcal: 285, p: 12, c: 36, f: 10 },
            { id: 'x2', name: 'Hamburguesa', unit: '1 Unidad', icon: 'üçî', type: 'cheat', kcal: 500, p: 25, c: 45, f: 25 },
            { id: 'x3', name: 'Papas Fritas', unit: '1 Porci√≥n', icon: 'üçü', type: 'cheat', kcal: 300, p: 3, c: 40, f: 15 },
            { id: 'x4', name: 'Helado', unit: '1 Bola', icon: 'üç¶', type: 'cheat', kcal: 150, p: 3, c: 20, f: 7 },
            { id: 'x5', name: 'Cerveza', unit: '1 Lata', icon: 'üç∫', type: 'cheat', kcal: 150, p: 1, c: 13, f: 0 },
            { id: 'x6', name: 'Vino Tinto', unit: '1 Copa', icon: 'üç∑', type: 'cheat', kcal: 125, p: 0, c: 4, f: 0 },
            { id: 'x7', name: 'Galletas', unit: '2 Un.', icon: 'üç™', type: 'cheat', kcal: 140, p: 1, c: 20, f: 7 }
        ];

        // --- STATE MANAGEMENT ---
        let user = { weight: 60, height: 165, age: 30, goal: 'cut', activeCortisolMode: null, detoxUnlocked: false, targetKcal: 0, targetProt: 0, targetCarb: 0, targetFat: 0, quizScores: { FACE: 0, BELLY: 0, SLEEP: 0 } };
        let consumed = {};
        let dailyChecks = {};
        let scanTimer = null;
        let isPlaying = false;

        function init() {
            // LOAD STORAGE
            const saved = localStorage.getItem('radar_deusafit_v4_5');
            if(saved) {
                const parsed = JSON.parse(saved);
                user = {...user, ...parsed.user};
                consumed = parsed.consumed || {};
                dailyChecks = parsed.dailyChecks || {};
            }

            document.getElementById('in-weight').value = user.weight;
            document.getElementById('in-height').value = user.height;
            document.getElementById('in-age').value = user.age;

            lucide.createIcons();
            const params = new URLSearchParams(window.location.search);
            if(params.get('unlock') === 'detox') user.detoxUnlocked = true;
            
            calcMacros();
            renderList();
            updateGoalUI();

            // Se j√° tem modo definido, esconde intro e mostra app
            if(user.activeCortisolMode) {
                document.getElementById('screen-intro').classList.replace('active-screen', 'hidden-screen');
                document.getElementById('app-shell').classList.replace('hidden-screen', 'active-screen');
                activateCortisol(user.activeCortisolMode);
            }
        }

        function saveState() {
            localStorage.setItem('radar_deusafit_v4_5', JSON.stringify({ user, consumed, dailyChecks }));
        }

        // --- SCANNER ---
        function startScan(e) {
            e.preventDefault();
            if (navigator.vibrate) navigator.vibrate([30, 40, 30]); 
            const btn = document.getElementById('fingerprint-btn');
            const fill = document.getElementById('scan-fill');
            const icon = document.getElementById('scan-icon');
            btn.classList.add('scale-95'); icon.classList.add('text-white');
            fill.style.transition = 'height 1.8s ease-in-out'; fill.style.height = '100%';
            scanTimer = setTimeout(() => { login(); }, 1800); 
        }

        function endScan() {
            if (navigator.vibrate) navigator.vibrate(0);
            const btn = document.getElementById('fingerprint-btn');
            const fill = document.getElementById('scan-fill');
            const icon = document.getElementById('scan-icon');
            clearTimeout(scanTimer);
            btn.classList.remove('scale-95'); icon.classList.remove('text-white');
            fill.style.transition = 'height 0.3s'; fill.style.height = '0%';
        }

        function login() {
            if (navigator.vibrate) navigator.vibrate(100);
            document.getElementById('screen-intro').classList.replace('active-screen', 'hidden-screen'); 
            
            // Se j√° fez quiz, vai pro app, sen√£o vai pro quiz
            if(user.activeCortisolMode) {
                document.getElementById('app-shell').classList.replace('hidden-screen', 'active-screen');
            } else {
                document.getElementById('screen-quiz').classList.replace('hidden-screen', 'active-screen');
            }
            lucide.createIcons();
        }

        // --- QUIZ LOGIC (5 QUESTIONS) ---
        function answerQuiz(type, qNum) {
            if(type !== 'NORMAL') user.quizScores[type]++;
            nextQ(qNum + 1);
        }

        function nextQ(q) { 
            document.querySelectorAll('.quiz-step').forEach(el => el.classList.add('hidden')); 
            const nextEl = document.getElementById('q'+q);
            if(nextEl) nextEl.classList.remove('hidden');
            else finishQuiz();
        }

        function finishQuiz() {
            document.querySelectorAll('.quiz-step').forEach(el => el.classList.add('hidden')); 
            document.getElementById('processing').classList.remove('hidden'); 
            
            // L√≥gica de Vencedor
            let winner = 'FACE';
            const s = user.quizScores;
            if(s.BELLY > s.FACE && s.BELLY >= s.SLEEP) winner = 'BELLY';
            if(s.SLEEP > s.FACE && s.SLEEP > s.BELLY) winner = 'SLEEP';
            
            setTimeout(() => { 
                document.getElementById('screen-quiz').classList.replace('active-screen', 'hidden-screen'); 
                document.getElementById('app-shell').classList.replace('hidden-screen', 'active-screen'); 
                activateCortisol(winner);
                openVideo(null, winner); // Abre o diagn√≥stico direto
            }, 2000); 
        }

        // --- CALCULADORA (INTOCADA + SAVE STATE) ---
        function calcMacros() {
            let tmb = (10 * user.weight) + (6.25 * user.height) - (5 * user.age) - 161;
            let target = tmb * 1.3;
            if(user.goal === 'cut') target -= 400; if(user.goal === 'bulk') target += 300;
            user.targetKcal = Math.round(target);
            if (user.activeCortisolMode === 'BELLY') {
                user.targetProt = Math.round(user.weight * 2.5); user.targetCarb = 50; 
                let remain = user.targetKcal - (user.targetProt * 4) - (user.targetCarb * 4); user.targetFat = Math.max(0, Math.round(remain / 9));
            } else if (user.activeCortisolMode === 'FACE') {
                user.targetProt = Math.round(user.weight * 1.8); user.targetFat = Math.round(user.weight * 0.6);
                let remain = user.targetKcal - (user.targetProt * 4) - (user.targetFat * 9); user.targetCarb = Math.max(0, Math.round(remain / 4));
            } else if (user.activeCortisolMode === 'SLEEP') {
                user.targetProt = Math.round(user.weight * 1.5); user.targetFat = Math.round(user.weight * 1.2);
                let remain = user.targetKcal - (user.targetProt * 4) - (user.targetFat * 9); user.targetCarb = Math.max(0, Math.round(remain / 4));
            } else {
                if(user.goal === 'cut') { user.targetProt = Math.round(user.weight * 2.2); user.targetFat = Math.round(user.weight * 0.7); } 
                else if (user.goal === 'bulk') { user.targetProt = Math.round(user.weight * 1.6); user.targetFat = Math.round(user.weight * 1.0); } 
                else { user.targetProt = Math.round(user.weight * 1.8); user.targetFat = Math.round(user.weight * 0.9); }
                let remain = user.targetKcal - (user.targetProt * 4) - (user.targetFat * 9); user.targetCarb = Math.max(0, Math.round(remain / 4));
            }
            saveState(); // Salva sempre que calcula
            updateHUD();
        }

        function setGoal(g) { user.goal = g; updateGoalUI(); calcMacros(); }

        // --- CORTISOL LOGIC (ATUALIZADA) ---
        function activateCortisol(mode) {
            user.activeCortisolMode = mode;
            document.querySelectorAll('[id^="btn-"]').forEach(btn => btn.className = "bg-gray-900/40 border border-gray-800 rounded-xl p-3 text-gray-400 transition-all flex flex-col items-center gap-2 group hover:bg-gray-800");
            document.getElementById('btn-'+mode).classList.add('btn-cortisol-active', mode);
            document.getElementById('cortisol-card').classList.remove('hidden');
            
            let color='blue', title='DRENAJE FACIAL', icon='droplet';
            if(mode==='FACE') { color='blue'; title='DRENAJE FACIAL'; icon='droplet'; }
            if(mode==='BELLY') { color='green'; title='VACUUM & LPF'; icon='shield'; }
            if(mode==='SLEEP') { color='purple'; title='AUDIO DELTA'; icon='moon'; }

            document.getElementById('cortisol-card').innerHTML = `
                <div class="glass-card p-5 rounded-xl border border-${color}-500/40 relative animate-fade-in bg-${color}-900/10">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-${color}-400 font-bold text-xs flex items-center gap-2 tracking-wider"><i data-lucide="${icon}" class="w-4 h-4"></i> ${title} ACTIVADO</h4>
                        <span class="text-[9px] bg-${color}-900/50 text-${color}-200 px-2 py-1 rounded border border-${color}-500/20 tracking-wider">MACROS AJUSTADOS</span>
                    </div>
                    <button onclick="openVideo(null, '${mode}')" class="w-full py-4 rounded-lg bg-${color}-500/20 border border-${color}-500/50 text-${color}-300 font-bold font-tech tracking-[0.2em] flex items-center justify-center gap-2 hover:bg-${color}-500/30 transition-all shadow-lg group">
                        <i data-lucide="file-text" class="w-5 h-5 group-hover:scale-110 transition-transform"></i> VER MI EXPEDIENTE
                    </button>
                </div>
            `;
            document.getElementById('protocol-status').innerHTML = `<i data-lucide="activity" class="w-3 h-3"></i> MODO: ${mode}`;
            document.getElementById('protocol-status').className = `text-[10px] text-${color}-400 font-tech tracking-widest uppercase animate-pulse flex items-center gap-1`;
            
            lucide.createIcons(); 
            calcMacros();
        }

        function resetCortisol() {
            user.activeCortisolMode = null;
            document.getElementById('cortisol-card').classList.add('hidden');
            document.querySelectorAll('[id^="btn-"]').forEach(btn => btn.className = "bg-gray-900/40 border border-gray-800 rounded-xl p-3 text-gray-400 transition-all flex flex-col items-center gap-2 group hover:bg-gray-800");
            document.getElementById('protocol-status').innerHTML = `<i data-lucide="shield-check" class="w-3 h-3"></i> SISTEMA NORMAL`;
            document.getElementById('protocol-status').className = "text-[10px] text-green-400 font-tech tracking-widest uppercase flex items-center gap-1";
            lucide.createIcons(); calcMacros();
        }

        // --- SMART MODAL (EXPEDIENTE) ---
        function openVideo(src, mode) {
            const modal = document.getElementById('modal-expediente');
            const content = document.getElementById('expediente-content');
            modal.classList.remove('hidden');
            
            const data = PROTOCOLS[mode];
            
            let mediaHTML = '';
            if(data.audioOnly) {
                mediaHTML = `
                <div class="bg-purple-900/10 border border-purple-500/20 rounded-xl p-6 text-center">
                    <div id="visualizer" class="visualizer-container mb-4">
                        <div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div>
                    </div>
                    <button onclick="toggleAudio()" class="mx-auto flex items-center gap-2 px-6 py-3 rounded-full bg-purple-500 hover:bg-purple-400 text-white font-bold tracking-widest transition-all shadow-[0_0_20px_rgba(168,85,247,0.4)]">
                        <i id="play-icon" data-lucide="play" class="w-5 h-5 fill-current"></i> <span id="play-btn-text">INICIAR FRECUENCIA</span>
                    </button>
                    <p class="text-[9px] text-gray-500 mt-4 uppercase tracking-widest">Use aud√≠fonos para efecto binaural</p>
                </div>`;
            } else {
                mediaHTML = `<div style="padding:56.25% 0 0 0;position:relative;"><iframe src="https://fast.wistia.net/embed/iframe/${data.videoId}?videoFoam=true" style="height:100%;left:0;position:absolute;top:0;width:100%;" frameborder="0" allowfullscreen></iframe></div>`;
            }

            content.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl text-white font-tech uppercase tracking-widest mb-1 text-${data.color}-400">${data.title}</h2>
                    <p class="text-xs text-gray-400">${data.sub}</p>
                </div>
                
                <h4 class="text-xs text-white font-bold mb-2 uppercase tracking-widest">¬øC√ìMO HACERLO?</h4>
                <div class="bg-white/5 p-4 rounded-lg text-xs text-gray-300 leading-relaxed mb-6 border-l-2 border-${data.color}-500">
                    ${data.desc}
                </div>

                <div class="glass-card p-1 rounded-xl border border-white/10 overflow-hidden mb-6">
                    ${mediaHTML}
                </div>
                
                <div class="space-y-4">
                    <h4 class="text-xs text-white font-bold uppercase tracking-widest">CHECKLIST DIARIO</h4>
                    ${data.steps.map(step => {
                        const isChecked = dailyChecks[step.id] ? 'checked' : '';
                        return `
                        <label class="nexus-check cursor-pointer flex gap-4 group">
                            <input type="checkbox" class="hidden" ${isChecked} onchange="toggleCheck('${step.id}')">
                            <div class="w-6 h-6 rounded border border-white/20 flex items-center justify-center shrink-0 transition-all group-hover:border-${data.color}-500">
                                <i data-lucide="check" class="w-4 h-4 text-black opacity-0 transition-opacity"></i>
                            </div>
                            <div>
                                <h4 class="text-sm text-gray-200 font-bold group-hover:text-${data.color}-400 transition-colors">${step.l}</h4>
                            </div>
                        </label>`;
                    }).join('')}
                </div>
            `;
            lucide.createIcons();
        }

        function closeExpediente() {
            document.getElementById('modal-expediente').classList.add('hidden');
            const audio = document.getElementById('audio-player');
            audio.pause(); isPlaying = false;
        }

        function toggleCheck(id) {
            dailyChecks[id] = !dailyChecks[id];
            saveState();
        }

        function toggleAudio() {
            const audio = document.getElementById('audio-player');
            const viz = document.getElementById('visualizer');
            const btn = document.getElementById('play-btn-text');
            const icon = document.getElementById('play-icon');
            
            if(isPlaying) {
                audio.pause();
                viz.classList.remove('playing');
                btn.innerText = "INICIAR FRECUENCIA";
                icon.setAttribute('data-lucide', 'play');
            } else {
                audio.play().catch(e => alert("Error: sleep_audio.mp3 no encontrado"));
                viz.classList.add('playing');
                btn.innerText = "PAUSAR SESI√ìN";
                icon.setAttribute('data-lucide', 'pause');
            }
            isPlaying = !isPlaying;
            lucide.createIcons();
        }

        // --- MANUTEN√á√ÉO LISTA ALIMENTOS (INTOCADA) ---
        function resetFood() { if(confirm("¬øBorrar consumo diario?")) { consumed = {}; saveState(); updateHUD(); renderList(); } }
        function renderList() {
            const container = document.getElementById('food-container');
            container.innerHTML = db.map(item => {
                const count = consumed[item.id] || 0;
                const isDanger = item.type === 'cheat';
                const activeClass = count > 0 ? (isDanger ? "border-red-500 bg-red-900/10" : "border-gold bg-white/5") : "border-white/5";
                let typeColor = "text-gray-500"; let typeLabel = item.type;
                if(item.type==='prot') typeColor="text-blue-400"; if(item.type==='carb') typeColor="text-yellow-400"; if(item.type==='fat') typeColor="text-orange-400";
                if(isDanger) { typeColor="text-red-500"; typeLabel = "‚ö†Ô∏è EVITAR"; }
                return `<div class="glass-card p-3 rounded-lg flex justify-between items-center ${activeClass} transition-all border border-white/5"><div class="flex items-center gap-4 flex-1"><span class="text-2xl">${item.icon}</span><div><div class="font-bold text-sm ${isDanger ? 'text-red-400' : 'text-gray-200'} tracking-wide">${item.name}</div><div class="flex gap-2 text-[10px] mt-0.5"><span class="${typeColor} font-bold uppercase tracking-wider">${typeLabel}</span><span class="text-gray-500">${item.kcal} kcal</span></div></div></div><div class="flex items-center gap-3 bg-black/40 rounded-lg p-1 border border-white/10"><button onclick="updateFood('${item.id}', -1)" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white transition-colors">-</button><span class="w-6 text-center font-tech font-bold text-white text-sm">${count}</span><button onclick="updateFood('${item.id}', 1)" class="w-8 h-8 flex items-center justify-center ${isDanger ? 'text-red-500 hover:text-red-400' : 'text-gold hover:text-yellow-300'} transition-colors">+</button></div></div>`;
            }).join('');
        }
        function updateFood(id, delta) { if(!consumed[id]) consumed[id] = 0; consumed[id] += delta; if(consumed[id] < 0) consumed[id] = 0; saveState(); updateHUD(); renderList(); }
        function updateHUD() {
            let totalKcal = 0, totalP = 0, totalC = 0, totalF = 0;
            for(const [id, count] of Object.entries(consumed)) { const item = db.find(x => x.id === id); if(item) { totalKcal += item.kcal * count; totalP += item.p * count; totalC += item.c * count; totalF += item.f * count; } }
            document.getElementById('current-kcal').innerText = totalKcal; document.getElementById('target-kcal').innerText = user.targetKcal;
            document.getElementById('val-prot').innerText = `${Math.round(totalP)}/${user.targetProt}g`; document.getElementById('val-carb').innerText = `${Math.round(totalC)}/${user.targetCarb}g`;
            document.getElementById('val-fat').innerText = `${Math.round(totalF)}/${user.targetFat}g`; document.getElementById('main-bar').style.width = Math.min((totalKcal / user.targetKcal) * 100, 100) + '%';
        }

        // --- LINKS / MODALS ---
        function openVipLink() { window.open(CONFIG_LINKS.vip, '_blank'); }
        function toggleConfig() { document.getElementById('config-panel').classList.toggle('hidden'); updateGoalUI(); }
        function saveConfig() { 
            user.weight = document.getElementById('in-weight').value || 60; 
            user.height = document.getElementById('in-height').value || 165;
            user.age = document.getElementById('in-age').value || 30;
            calcMacros(); toggleConfig(); 
        }
        function updateGoalUI() { document.querySelectorAll('.goal-btn').forEach(b => b.classList.remove('active', 'bg-white/20')); const btn = document.getElementById('goal-'+user.goal); if(btn) btn.classList.add('active', 'bg-white/20'); }
        function handleDetoxClick() { if(user.detoxUnlocked) document.getElementById('modal-gallery').classList.remove('hidden'); else openUpsell('RECETAS DETOX'); }
        
        // --- FUN√á√ÉO DO MODAL ATUALIZADA (CIRURGIA FEITA AQUI) ---
        function openUpsell(t) { 
            document.getElementById('modal-upsell').classList.remove('hidden'); 
            const title = document.getElementById('modal-title'); 
            const btn = document.getElementById('modal-btn'); 
            const icon = document.getElementById('modal-icon');
            const card = document.getElementById('upsell-card');
            const glow = document.getElementById('modal-glow');
            const desc = document.getElementById('modal-desc');

            // Reset classes
            card.className = "w-full max-w-sm p-8 rounded-xl border relative overflow-hidden shadow-2xl transition-all";

            if(t === 'RECETAS DETOX') { 
                title.innerText = "RECETAS ALQU√çMICAS"; 
                btn.innerText = "DESBLOQUEAR AHORA";
                btn.href = CONFIG_LINKS.detox; 
                icon.setAttribute('data-lucide', 'flask-conical');
                
                // Estilo Verde Neon (Print 1)
                card.style.background = "#000";
                card.style.borderColor = "#22c55e"; // Green-500
                glow.style.backgroundColor = "#22c55e";
                title.className = "font-tech text-3xl mb-4 uppercase tracking-[0.2em] font-light leading-none text-white";
                btn.className = "block w-full bg-green-600 text-black font-bold font-tech py-4 text-center tracking-[0.2em] rounded-lg shadow-lg hover:shadow-green-500/50 transition-all";
                icon.style.color = "#4ade80"; // Green-400
            } 
            
            if(t === 'DEUSA') { 
                title.innerText = "RETO DEUSA 21"; 
                title.innerHTML = "RETO DEUSA<br><span class='text-5xl font-bold'>21</span>";
                btn.innerText = "DESBLOQUEAR AHORA";
                btn.href = CONFIG_LINKS.deusa; 
                icon.setAttribute('data-lucide', 'crown');

                // Estilo Dourado (Print 2)
                card.style.background = "#000";
                card.style.borderColor = "#D4AF37"; // Gold
                glow.style.backgroundColor = "#D4AF37";
                title.className = "font-tech text-3xl mb-4 uppercase tracking-[0.2em] font-light leading-none text-white";
                btn.className = "block w-full bg-yellow-600 text-black font-bold font-tech py-4 text-center tracking-[0.2em] rounded-lg shadow-lg hover:shadow-yellow-500/50 transition-all";
                icon.style.color = "#D4AF37";
            } 
            
            if(t === 'IGNICION') { 
                title.innerText = "SISTEMA RESE7E"; 
                title.innerHTML = "SISTEMA<br>RESE7E";
                btn.innerText = "DESBLOQUEAR AHORA";
                btn.href = CONFIG_LINKS.ignicion; 
                icon.setAttribute('data-lucide', 'zap');

                // Estilo Roxo (Print 3)
                card.style.background = "#000";
                card.style.borderColor = "#a855f7"; // Purple-500
                glow.style.backgroundColor = "#a855f7";
                title.className = "font-tech text-3xl mb-4 uppercase tracking-[0.2em] font-light leading-none text-white";
                btn.className = "block w-full bg-purple-600 text-black font-bold font-tech py-4 text-center tracking-[0.2em] rounded-lg shadow-lg hover:shadow-purple-500/50 transition-all";
                icon.style.color = "#c084fc"; // Purple-400
            } 
            
            lucide.createIcons(); 
        }
        function closeModal() { document.getElementById('modal-upsell').classList.add('hidden'); }

        init();
    </script>
</body>
</html>